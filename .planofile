router_config_template = """
router {{
    mode: standalone
    id: quiver-test-router
}}

listener {{
    host: {}
    port: {}
    linkCapacity: 1000
    authenticatePeer: off
    saslMechanisms: ANONYMOUS
}}
"""

router_host = "localhost"
router_port = 45672
router_config = router_config_template.format(router_host, router_port)
router_config_file = write(make_temp_file(), router_config)

transfers_file = make_temp_file()

duration_arg = CommandArgument("duration", default=10, positional=False,
                               help="The time to run (excluding warmup) in seconds")
warmup_arg = CommandArgument("warmup", default=10, positional=False,
                             help="Warmup time in seconds")

@command
def clean(app):
    remove("pellmell")
    remove("perf.data")
    remove("perf.data.old")
    remove("flamegraph.html")
    remove("flamegraph.html.old")

@command
def check(app):
    check_program("gcc", "I can't find gcc.  Run 'dnf install gcc'.")
    check_program("perf", "I can't find the perf tools.  Run 'dnf install perf'.")
    check_program("pidstat", "I can't find pidstat.  Run 'dnf install sysstat'.")
    check_program("skrouterd", "I can't find skrouterd.  Make sure it is on the path")

    perf_event_paranoid = read("/proc/sys/kernel/perf_event_paranoid")

    if perf_event_paranoid != "-1\n":
        exit("Perf events are not enabled.  Run 'echo -1 > /proc/sys/kernel/perf_event_paranoid' as root.")

@command
def build(app):
    check(app)
    run("gcc pellmell.c -o pellmell -g -O2 -std=c99 -fno-omit-frame-pointer -lqpid-proton -lqpid-proton-proactor")

@command(args=[duration_arg])
def run_(app, duration=10):
    check(app)
    build(app)

    with start(f"skrouterd --config {router_config_file}") as router:
        with start(f"pidstat 2 --human -t -p {router.pid}"):
            await_port(45672)

            with start("./pellmell receive", stdout=transfers_file):
                with start("./pellmell send"):
                    sleep(duration)

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // duration, "<<")

@command(args=[duration_arg, warmup_arg])
def flamegraph(app, duration=10, warmup=10):
    build(app)

    with start(f"skrouterd --config {router_config_file}") as router:
        await_port(45672)

        with start("./pellmell receive", stdout=transfers_file):
            with start("./pellmell send"):
                sleep(warmup)

                if exists("flamegraph.html"):
                    move("flamegraph.html", "flamegraph.html.old")

                run(f"perf script flamegraph -F 99 --call-graph dwarf -p {router.pid} sleep {duration}")

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // (warmup + duration), "<<")

@command(args=[duration_arg, warmup_arg])
def stat(app, duration=10, warmup=10):
    build(app)

    with start(f"skrouterd --config {router_config_file}") as router:
        await_port(45672)

        with start("./pellmell receive", stdout=transfers_file):
            with start("./pellmell send"):
                sleep(warmup)
                run(f"perf stat --detailed -p {router.pid} sleep {duration}")

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // warmup + duration, "<<")

@command(args=[duration_arg, warmup_arg])
def record(app, duration=10, warmup=10):
    build(app)

    with start(f"skrouterd --config {router_config_file}") as router:
        await_port(45672)

        with start("./pellmell receive", stdout=transfers_file):
            with start("./pellmell send"):
                sleep(warmup)
                run(f"perf record -F 99 --call-graph dwarf -p {router.pid} sleep {duration}")

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // (warmup + duration), "<<")

@command(args=[duration_arg, warmup_arg])
def stat(app, duration=10, warmup=10):
    build(app)

    with start(f"skrouterd --config {router_config_file}") as router:
        await_port(45672)

        with start("./pellmell receive", stdout=transfers_file):
            with start("./pellmell send"):
                sleep(warmup)
                run(f"perf stat -d -p {router.pid} sleep {duration}")

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // (warmup + duration), "<<")

@command
def self_test(app):
    run_(app, duration=0.1)
    flamegraph(app, duration=0.1, warmup=0.1)
    record(app, duration=0.1, warmup=0.1)
    stat(app, duration=0.1, warmup=0.1)
