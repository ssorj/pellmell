config_template = """
router {{
    mode: standalone
    id: quiver-test-router
}}

listener {{
    host: {}
    port: {}
    linkCapacity: 1000
    authenticatePeer: off
    saslMechanisms: ANONYMOUS
}}
"""

@command
def build(app):
    run("gcc pellmell.c -o pellmell -g -O2 -std=c99 -fno-omit-frame-pointer -lqpid-proton -lqpid-proton-proactor")

@command
def clean(app):
    remove("pellmell")

@command
def check_env(app):
    check_program("perf")
    check_program("pidstat")
    check_program("qdrouterd")
    check_program("wc")

    # echo -1 > /proc/sys/kernel/perf_event_paranoid

host = "localhost"
port = 45672
config = config_template.format(host, port)
config_file = write(make_temp_file(), config)
transfers_file = make_temp_file()

@command(name="run")
def run_(app):
    check_env(app)
    build(app)

    with start(f"qdrouterd --config {config_file}") as router:
        with start(f"pidstat 2 --human -t -p {router.pid}"):
            await_port(45672)

            with start("./pellmell receive", stdout=transfers_file):
                with start("./pellmell send"):
                    sleep(30)
                    # run(f"perf stat -d -d -p {router.pid} --timeout 10000")
                    # run(f"perf record -g -p {router.pid} sleep 10")
                    # run(f"perf script flamegraph -F 99 --call-graph dwarf -p {router.pid} sleep 10")

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // 30, "<<")

@command
def flamegraph(app):
    check_env(app)
    build(app)

    with start(f"qdrouterd --config {config_file}") as router:
        await_port(45672)

        with start("./pellmell receive", stdout=transfers_file):
            with start("./pellmell send"):
                sleep(10)
                run(f"perf script flamegraph -F 99 --call-graph dwarf -p {router.pid} sleep 10")
                sleep(10)

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // 30, "<<")

@command
def record(app):
    check_env(app)
    build(app)

    with start(f"qdrouterd --config {config_file}") as router:
        await_port(45672)

        with start("./pellmell receive", stdout=transfers_file):
            with start("./pellmell send"):
                sleep(10)
                run(f"perf record -F 99 --call-graph dwarf -p {router.pid} sleep 10")
                sleep(10)

    count = int(call(f"wc -l {transfers_file}").split()[0])
    print(">>", count // 30, "<<")
