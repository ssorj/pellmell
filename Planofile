config_template = """
router {{
    mode: standalone
    id: quiver-test-router
}}

listener {{
    host: {}
    port: {}
    linkCapacity: 1000
    authenticatePeer: off
    saslMechanisms: ANONYMOUS
}}
"""

@command
def build(app):
    run("gcc pellmell.c -o pellmell -g -O2 -std=c99 -fno-omit-frame-pointer -lqpid-proton -lqpid-proton-proactor")

@command(name="run")
def run_(app):
    build(app)

    check_program("pidstat")
    check_program("qdrouterd")
    check_program("wc")

    host = "localhost"
    port = 45672
    config = config_template.format(host, port)
    config_file = write(make_temp_file(), config)

    with start(f"qdrouterd --config {config_file}") as router:
        with start(f"pidstat 2 --human -t -p {router.pid}"):
            await_port(45672)

            with start("./pellmell receive", stdout="transfers"):
                run("./pellmell send")

    count = int(call("wc -l transfers").split()[0])
    print(">>", count // 30, "<<")

@command
def clean(app):
    remove("pellmell")
    remove("transfers")
